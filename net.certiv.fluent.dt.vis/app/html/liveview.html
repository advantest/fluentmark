<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='x-ua-compatible' content='IE=edge' />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Fluentmark Live View</title>
    <base href="%path%" />
    <style media="screen" type="text/css">
    %styles%
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
    <script type="x-mathjax-config">
        MathJax.Hub.Config({
				messageStyle: "none",
				positionToHash: true,
				showMathMenu: true,
    			tex2jax: {
      				inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      				displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
      				processEscapes: true
    			},
				TeX: {
					equationNumbers: {autoNumber: "AMS"}
				},
			});
			MathJax.Hub.Register.StartupHook("End", typeset);
		</script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"></script>
    <script type="text/javascript">
    // Well-defined constants
    const Msg = {
        Code: {
            NACK: -1,
            ACK: 0,
            REQUEST: 1,
            REPLY: 2,
        },
        Request: {
            AUTH: 10,
            HELO: 12,
            REFRESH: 20,
            UPDATE: 22,
            HEARTBEAT: 200,
        },
    };

    // Prototypical message envelope
    const envl = {
        code: Msg.Code.NACK,
        request: Msg.Request.HELO,
        target: '',
        msg: {},
        status: '',
        timestamp: 0,
    };

    // Prototypical message
    const msg = {
        ref: 0,
        target: '',
        content: '',
        line: -1,
        total: -1,
    };
    </script>
    <script type="module">
        import Vue from 'https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.esm.browser.js'
			import VueNativeSock from 'https://cdn.jsdelivr.net/npm/vue-native-websocket@2.0.14/dist/build.min.js'
			Vue.use(VueNativeSock, '%socket%', {
				format: 'json',
				reconnection: true,
				reconnectionAttempts: 5,
				reconnectionDelay: 3000,
			})
		</script>
</head>

<body>
    <span id="app" v-html="rawHtml"></span>
    <script type="text/javascript">
    window.Liveview = new Vue({
        el: '#app',
        data: {
            envlCode: Msg.Code.NACK,
            envlRequest: Msg.Request.HELO,
            envlTarget: '',

            rawHtml: 'Ready...',
            msgLine: -1,
            msgTotal: -1,

            socket: {
                ws: null,
                isConnected: false,
                reconnectError: false,
                heartBeatInterval: 50000,
                heartBeatTimer: 0
            },
        },
        mounted: function() {
            this.refresh();
            console.log('mounted')
        },
        updated: function() {
            this.refresh();
            console.log('updated')
        },
        sockets: {
            onmessage(envelope) {
                console.log('Message received', envelope)
                this.envlCode = envelope.code;
                this.envlRequest = envelope.request;
                this.envlTarget = envelope.target;
                this.rawHtml = envelope.msg.content;
                this.msgLine = envelope.msg.line;
                this.msgTotal = envelope.msg.total;
            },

            connect() {
                let e = Object.assign({}, envl);
                e.code = Msg.Kind.ACK;
                e.request = Msg.Request.HELO;
                e.target = 'Liveview';
                e.msg = Object.assign({}, msg);
                e.timestamp = Date.now();
                this.socket.send(JSON.stringify(e));
                console.log('socket connected')
            },
            disconnect() {
                console.log('socket disconnected')
            },

            onopen() {
                this.socket.ws = event.currentTarget;
                this.socket.isConnected = true;
                console.log('Ws opened');

                this.socket.heartBeatTimer = setInterval(() => {
                    this.socket.isConnected && this.socket.ws.sendObj({
                        code: 0, // Msg.Code.ACK,
                        request: 200, // Msg.Request.HEARTBEAT,
                        status: 'Heartbeat'
                    });
                }, this.socket.heartBeatInterval);
            },
            onclose() {
                this.socket.isConnected = false;
                clearInterval(this.socket.heartBeatTimer);
                this.socket.heartBeatTimer = 0;
                console.log('Ws closed @', new Date());
            },
            onerror() {
                console.log('socket error')
            }
        },
        methods: {
            refresh: function() {
                this.$nextTick(function() {
                    var blocks = this.$el.querySelectorAll('code');
                    for (var idx = 0; idx < blocks.length; idx++) {
                        hljs.highlightBlock(blocks[idx]);
                    }
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
                });
            },
            send: function(val) {
                this.socket.ws.send(val)
            },
            check: function() {
                alert('Check: ' + this.rawHtml);
            },
            clear: function() {
                this.rawHtml = 'Cleared...';
            },
            set: function(source) {
                this.rawHtml = source;
            },
        },
    });
    </script>
</body>

</html>
