name: Java CI with Maven/Tycho

on:
  push:
    branches-ignore:
    - main
    - master
  pull_request:
    branches:
    - develop

jobs:
  build:

    #runs-on: ubuntu-latest
    runs-on: macos-13
    permissions:
      contents: read
      packages: read

    steps:
    - name: Install Graphviz (needed for PlantUML)
      #run: sudo apt install graphviz
      run: brew install graphviz

    - name: Install pandoc (used by FluentMark for rendering Markdown)
      run: brew install pandoc

    - name: Check out
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    # work-around since using the token with the setup-java action seems not to work
    - name: Set up settings.xml for Maven and GitHub packages access
      run: |
        mkdir -p $HOME/.m2
        cat > $HOME/.m2/settings.xml <<EOF
        <settings>
          <servers>
            <server>
              <id>github-packages-flexmark</id>
              <username>__token__</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
            <server>
              <id>github-packages-markdown-core</id>
              <username>__token__</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>

    - name: Build with Maven/Tycho
      # -U means update snapshots (needed, since we might depend on a markdown-core SNAPSHOT version)
      run: mvn -B clean verify --file pom.xml -U -Dcode-coverage

    # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive
    #- name: Update dependency graph
    #  uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6

    # see https://github.com/uhafner/quality-monitor
    # - name: Run quality monitor
    #   uses: uhafner/quality-monitor@v1
    #   with:
    #     config: >
    #       {
    #         "tests": {
    #           "name": "JUnit",
    #           "tools": [
    #             {
    #               "id": "test",
    #               "name": "Unittests",
    #               "pattern": "**/target/*-reports/TEST*.xml"
    #             }
    #           ]
    #         },
    #         "coverage": [
    #           {
    #             "name": "JaCoCo",
    #             "tools": [
    #               {
    #                 "id": "jacoco",
    #                 "name": "Line Coverage",
    #                 "metric": "line",
    #                 "sourcePath": "src",
    #                 "pattern": "**/jacoco.xml"
    #               },
    #               {
    #                 "id": "jacoco",
    #                 "name": "Branch Coverage",
    #                 "metric": "branch",
    #                 "sourcePath": "src",
    #                 "pattern": "**/jacoco.xml"
    #               }
    #             ]
    #           }
    #         ]
    #       }